{% extends "base.html" %}
{% block content %}
<h1 class="text-center romantic">Carrito de Compras</h1>
{% if cart_items %}
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Imagen</th>
        <th>Producto</th>
        <th>Código de Producto</th>
        <th>Precio Unitario</th>
        <th>Cantidad</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody>
      {% for item in cart_items %}
      <tr data-item-id="{{ item.id }}">
        <td>
          <img src="{{ url_for('static', filename=item.image) }}" alt="{{ item.product_name }}" style="max-width:100px;">
        </td>
        <td>{{ item.product_name }}</td>
        <td>{{ item.product_code }}</td>
        <td>S/ {{ item.unit_price | round(2) }}</td>
        <td>
          <button class="btn-decrease" data-item-id="{{ item.id }}">-</button>
          <input type="number" class="quantity-input" data-item-id="{{ item.id }}" value="{{ item.quantity }}" min="1">
          <button class="btn-increase" data-item-id="{{ item.id }}">+</button>
        </td>
        <td>S/ <span class="item-subtotal">{{ item.subtotal | round(2) }}</span></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="text-right">
    <p><strong>Subtotal:</strong> S/ <span id="cart-subtotal">{{ cart_subtotal | round(2) }}</span></p>
    <p><strong>Gastos de Envío:</strong> S/ <span id="shippingCost">{{ shipping_cost | round(2) }}</span></p>
    {% if coupon_discount and coupon_discount > 0 %}
      <p><strong>Descuento por Cupón:</strong> - S/ <span id="couponDiscount">{{ coupon_discount | round(2) }}</span></p>
    {% endif %}
    <p><strong>Total:</strong> S/ <span id="cart-total">{{ total | round(2) }}</span></p>
  </div>
{% else %}
  <p>El carrito está vacío.</p>
{% endif %}
{% endblock %}

<!-- JavaScript para actualizar cantidades y recalcular subtotales y total -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    function updateSubtotal(itemId) {
      const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
      const quantityInput = row.querySelector('input.quantity-input');
      const priceText = row.querySelector('td:nth-child(4)').textContent;
      const price = parseFloat(priceText.replace('S/','').trim());
      const quantity = parseInt(quantityInput.value);
      const newSubtotal = (price * quantity).toFixed(2);
      row.querySelector('.item-subtotal').textContent = newSubtotal;
      recalcTotal();
    }
    
    function recalcTotal() {
      let total = 0;
      document.querySelectorAll('.item-subtotal').forEach(function(elem) {
        total += parseFloat(elem.textContent);
      });
      document.getElementById('cart-total').textContent = total.toFixed(2);
    }
    
    document.querySelectorAll('.btn-increase').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const itemId = this.getAttribute('data-item-id');
        const input = document.querySelector(`input.quantity-input[data-item-id="${itemId}"]`);
        input.value = parseInt(input.value) + 1;
        updateSubtotal(itemId);
      });
    });
    
    document.querySelectorAll('.btn-decrease').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const itemId = this.getAttribute('data-item-id');
        const input = document.querySelector(`input.quantity-input[data-item-id="${itemId}"]`);
        if (parseInt(input.value) > 1) {
          input.value = parseInt(input.value) - 1;
          updateSubtotal(itemId);
        }
      });
    });
  });
</script>
